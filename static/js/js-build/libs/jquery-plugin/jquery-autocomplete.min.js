/*
 *  Autocomplete Plugin for JQuery 
 *  Version   : beta 1.0 
 *  Date      : 11/27/2011
 *  Licence   : GPL v3 : http://www.gnu.org/licenses/gpl.html  
 *  Author    : DEMONTE Jean-Baptiste
 *  Contact   : jbdemonte@gmail.com
 */

(function(e){function s(t){var n;return e.isArray(t)?(n=[],e.each(t,function(e,t){n.push(t)})):typeof t=="object"?n=e.extend(!0,{},t):n=t,n}function o(n){var o={},u,a,l,h=-1,p=0,v,m={},y=!1,b=!1,w=this,E={key:function(e){w.key.apply(w,[e])},focusout:function(t){e(this).data(r+"-focus")||w.hide(!0)},dblclick:function(){l||w.updateTOComplete()}};this.init=function(t){o=e.extend(!0,{},i,t),typeof o.source=="string"&&(o.source=this.splitData(o.source)),t&&typeof t=="object"&&typeof t.once!="undefined"&&t.once&&typeof t.filter=="undefined"&&(o.filter=!0),n.attr("autocomplete","off"),this.bind()},this.splitData=function(e){return o.splitChr?e.split(o.splitChr):e.split(/\r\n|\r|\n/)},this.getSource=function(e){return typeof e=="function"?this.getSource.apply(this,[e.apply(n,[n.val()])]):typeof e=="string"?this.splitData(e):e},this.flush=function(){m={}},this.bind=function(){y||(n[e.browser.opera?"keypress":"keydown"](E.key),n.focusout(E.focusout),n.dblclick(E.dblclick),y=!0)},this.unbind=function(){y&&(n.unbind(e.browser.opera?"keypress":"keydown",E.key),n.unbind("focusout",E.focusout),n.unbind("dblclick",E.dblclick),y=!1)},this.updateToAutoHide=function(){if(!o.autohide)return;this.stopToAutoHide(),a=setTimeout(function(){w.hide(w,[!0])},o.autohide)},this.stopToAutoHide=function(){a&&(clearTimeout(a),a=null)},this.updateTOComplete=function(e){var t=this;clearTimeout(u),u=setTimeout(function(){t.complete.apply(t,[])},e?0:o.delay)},this.hover=function(t,n){var r=l?e("li",l).eq(t):null;r&&(r[(n?"add":"remove")+"Class"]("hover"),n&&this.scroll(r))},this.scroll=function(e){var t=l.scrollTop(),n=l.innerHeight(),r=e.position().top,i=e.outerHeight();r<0?(b=!0,l.scrollTop(t+r)):r+i>n&&(b=!0,l.scrollTop(t+r-n+i))},this.getPageUpDownItem=function(t){if(!l)return!1;var n=l.innerHeight(),r=0,i=h;return e("li",l).each(function(t,i){var s=e(i);r+=s.position().top>=0&&s.position().top+s.outerHeight()<=n?1:0}),h<0?(t?p:r)-1:(i+=t?-r:r,i=Math.max(0,i),i=Math.min(i,p-1),o.loop&&i==h&&(i=i===0?p-1:0),i)},this.key=function(t){var n=t.keyCode,r;n!==9&&(!l&&n!==27&&n!==13?this.updateTOComplete():n===38||n===40?(r=h+(n===38?-1:1),o.loop&&(r<0?r=p-1:r>p-1&&(r=0)),r=Math.max(0,r),r=Math.min(r,p-1),this.preselect(r),t.preventDefault()):n===33||n===34?(r=this.getPageUpDownItem(n===33),r!==!1&&this.preselect(r),t.preventDefault()):n===13?h!==-1?(this.select(h,e("li",l).eq(h).text()),t.preventDefault(),t.stopImmediatePropagation()):this.hide(!0):n===27?(this.preselect(-1),this.hide(!0)):this.updateTOComplete())},this.data=function(){var t,r="value";return typeof o.cb.populate=="function"?t=e.extend(!0,{},o.ajax.data,o.cb.populate.apply(n,[])):(t=e.extend(!0,{},o.ajax.data),o.name&&o.name.length?r=o.name:n.attr("name")&&n.attr("name").length?r=n.attr("name"):n.attr("id")&&n.attr("id").length&&(r=n.attr("id")),t[r]=n.val()),t},this.complete=function(){var e=n.val();if(o.minLength&&o.minLength>e.length){this.hide(!0)&&this.preselect(-1);return}o.source?this.completeSource():this.completeAjax()},this.filterData=function(e,t){var r=new RegExp((o.prefix?"^":"")+n.val().replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),i=[],s;for(s=0;s<e.length;s++)r.test(t(e[s]))&&i.push(e[s]);return i},this.completeSource=function(){this.show(this.getSource(o.source),!0)},this.completeAjax=function(){var t=this,r=n.val(),i;if(m&&(o.once&&!e.isEmptyObject(m)||o.cache&&typeof m[r]!="undefined")){var u=o.once?s(m):s(m[r]);typeof o.cb.process=="function"&&(u=o.cb.process.apply(n,[u,o.once?"once":"cache"])),typeof u=="string"&&(u=t.splitData(u)),this.show(u,o.filter);return}i=e.extend(!0,{},o.ajax),i.success=function(e,i,u){o.once?m=s(e):o.cache&&(m[r]=s(e)),typeof o.cb.process=="function"&&(e=o.cb.process.apply(n,[e,i,u])),typeof e=="string"&&(e=t.splitData(e)),t.show.apply(t,[e,o.filter])},i.data=this.data(),e.ajax(i)},this.preselect=function(e){this.updateToAutoHide();if(h===e)return;this.hover(h,!1),h=e,this.hover(h,!0),typeof o.cb.preselect=="function"&&o.cb.preselect.apply(n,[h===-1?null:v[h],h])},this.select=function(e,t){this.stopToAutoHide(),t===null?t=n.val():n.val(t),this.hide(),typeof o.cb.select=="function"&&o.cb.select.apply(n,[v[e],e])},this.show=function(t,i){var s=this,u=n.position(),a=e.browser.msie?n.outerWidth():n.width(),c=o.cb.cast||function(e){return e};v=t,this.hide();if(!t||typeof t!="object"||!t.length)return;if(typeof i=="undefined"&&o.filter||i)t=this.filterData(t,c);l=e('<ul class="'+o.className+'"></ul>').css("position","absolute").css("left",u.left+"px").css("top",u.top+n.outerHeight()+"px").scroll(function(){b=!1}),o.width==="auto"?l.css(e.browser.msie?"width":"minWidth",a+"px"):o.width===!1?l.css("width",a+"px").css("overflow","hidden"):l.css("width",o.width).css("overflow","hidden"),h=-1,p=t.length,e.each(t,function(t,n){var r=e("<li></li>"),i=e("<a></a>");i.click(function(){s.select.apply(s,[t,c(n)])}),r.hover(function(){b||s.preselect(t)}),l.append(r.append(i.append(c(n))))}),l.hover(function(){n.data(r+"-focus",!0),s.stopToAutoHide()},function(){n.data(r+"-focus",!1),s.updateToAutoHide(),n.is(":focus")||n.trigger("focusout")}),n.after(l),e.browser.msie&&e.each("min max".split(" "),function(t,n){e.each("Width Height".split(" "),function(e,r){var i=parseInt(l.css(n+r));!isNaN(i)&&l[r.toLowerCase()]()<i^t&&l.css(r.toLowerCase(),i+"px")})}),this.updateToAutoHide()},this.reverse=function(t){var n=null;return e("li",l).each(function(r,i){n===null&&e(i).text()===t&&(n=r)}),n},this.hide=function(e){if(l){if(e){var t=n.val(),r=!t.length||o.minLength&&o.minLength>t.length?null:this.reverse(t);if(r!==null){this.select(r);return}typeof o.cb.unselect=="function"&&o.cb.unselect.apply(n,[])}return this.stopToAutoHide(),l.remove(),l=null,h=-1,!0}return!1},this.isPublic=function(e){for(var n=0;n<t.length;n++)if(t[n]===e)return!0;return!1},this.process=function(){var e=[];for(var t=0;t<arguments.length;t++)e.push(arguments[t]);if(e.length&&typeof e[0]=="string"){var n=e.shift();this.isPublic(n)&&this[n].apply(this,e)}else this.init.apply(this,e)}}var t=["enable","disable","flushCache","trigger","display","close"],n=this,r="autocomplete",i={ajax:{url:document.URL,type:"POST",dataType:"json",data:{}},cb:{populate:null,cast:null,process:null,preselect:null,select:null,unselect:null},width:"auto",delay:250,name:null,minLength:1,cache:!0,once:!1,filter:!1,source:null,prefix:!0,splitChr:null,autohide:!1,loop:!0,className:r};o.prototype.flushCache=function(){this.flush()},o.prototype.enable=function(){this.bind()},o.prototype.disable=function(){this.unbind(),this.preselect(-1),this.hide()},o.prototype.trigger=function(){this.updateTOComplete(!0)},o.prototype.display=function(e,t){this.show(this.getSource(e),t)},o.prototype.close=function(){this.hide()},e.fn.autocomplete=function(){var t=arguments;return e.each(this,function(){var n=e(this),i=n.data(r);i||(i=new o(n),n.data(r,i)),i.process.apply(i,t)}),this}})(jQuery);